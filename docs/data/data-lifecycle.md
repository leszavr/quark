# Жизненный цикл данных

## Версия
1.0

## Статус
Утверждён

## Цель
Определить политики хранения, обработки и удаления данных в системе Quark, с учётом требований GDPR, ФЗ-152 и внутренних стандартов безопасности.

---

## 1. Типы данных и сроки хранения

| Тип данных | Пример | Срок хранения | Действие после истечения |
|----------|--------|----------------|--------------------------|
| **Посты** | Текст, заголовок, теги | Неограниченно (пока пользователь не удалит) | Архивация (не в поиске) |
| **Медиа** | Изображения, видео | 5 лет (или до удаления поста) | Удаление из MinIO |
| **Логи** | HTTP-запросы, ошибки | 30 дней | Автоматическое удаление |
| **Трейсы (traces)** | Distributed tracing | 7 дней | Удаление |
| **Метрики** | Latency, RPS | 90 дней | Агрегация и удаление сырых данных |
| **Контекст ИИ** | Диалоги, промпты | 1 час | Автоматическая очистка |
| **Сессии** | JWT, cookies | До истечения токена (15 мин) + refresh (7 дней) | Инвалидация |
| **Данные модерации** | Флаги, комментарии модератора | 3 года | Архивация |
| **Данные аналитики** | Просмотры, реакции | 2 года | Агрегация, удаление PII |
| **Резервные копии** | Velero, S3 | 30 дней | Удаление старых версий |

---

## 2. Процесс автоматического удаления

### 2.1. По расписанию
- Ежедневно в 02:00 UTC запускается **cron-задача**:
  - Удаляет логи старше 30 дней
  - Очищает трейсы старше 7 дней
  - Архивирует аналитику старше 2 лет

### 2.2. По запросу пользователя
1. Пользователь нажимает "Удалить аккаунт" в настройках
2. Система:
   - Помечает все данные как `pending_deletion`
   - Отправляет уведомление: "Ваши данные будут удалены через 7 дней"
   - Через 7 дней:
     - Удаляет посты, медиа, сессии
     - Очищает контекст ИИ
     - Обнуляет PII в аналитике
3. Подтверждение отправляется пользователю

> ✅ Соответствует **GDPR (право на забвение)** и **ФЗ-152**

---

## 3. Хранение и шифрование

| Данные | Хранение | Шифрование |
|-------|---------|-----------|
| Посты | PostgreSQL | TDE (at rest), TLS (in transit) |
| Медиа | MinIO | SSE-S3 (at rest), TLS |
| Логи | Loki | TLS (in transit) |
| Трейсы | Tempo | TLS |
| Контекст ИИ | Redis | AES-256 (at rest), TLS |
| Резервные копии | S3 | KMS, TLS |

---

## 4. Восстановление данных
- Только **администратор** может восстановить данные в течение 7 дней после удаления
- Через CLI:
  ```bash
  quark data:restore --user user-123 --backup backup-2025-04-05
  ```
- Все действия логируются в `audit-log`