
### **"–°–æ–∑–¥–∞–π –∏ –Ω–∞—Å—Ç—Ä–æ–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å media-service –Ω–∞ NestJS –¥–ª—è Quark"**

```text
–¢—ã ‚Äî senior full-stack —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å `media-service` –Ω–∞ **NestJS (TypeScript)**, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –∑–∞–≥—Ä—É–∑–∫—É, –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤.

–¶–µ–ª—å: –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ, –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –≤ —Å–∏—Å—Ç–µ–º–µ Quark.

–†–∞–±–æ—Ç–∞–π –≤ –∫–∞—Ç–∞–ª–æ–≥–µ: `/var/www/quark/services/media-service`

---

### üìÅ –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

1. –ü–µ—Ä–µ–π–¥–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥:
   ```bash
   cd /var/www/quark/services
   mkdir media-service && cd media-service
   ```

2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π NestJS:
   ```bash
   npm create nest@latest . --package-manager=npm --strict=false --skip-git
   ```
   - Bundler: `webpack`
   - Package manager: `npm`
   - Dockerfile: `Yes`
   - README: `Yes`

---

### üì¶ –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm install \
  @nestjs/minio \
  @nestjs/serve-static \
  multer \
  @types/multer \
  sharp \
  minio \
  uuid \
  mime \
  --save

npm install \
  @types/sharp \
  --save-dev
```

---

### üóÇÔ∏è –®–∞–≥ 3: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ media/
‚îÇ   ‚îú‚îÄ‚îÄ media.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ media.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ media.module.ts
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ minio.config.ts
‚îÇ   ‚îî‚îÄ‚îÄ media.config.ts
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îî‚îÄ‚îÄ upload.dto.ts
‚îú‚îÄ‚îÄ interfaces/
‚îÇ   ‚îî‚îÄ‚îÄ media-file.interface.ts
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ image.processor.ts
‚îú‚îÄ‚îÄ main.ts
‚îî‚îÄ‚îÄ health.controller.ts (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

---

### üñºÔ∏è –®–∞–≥ 4: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

#### 1. `image.processor.ts`
–§—É–Ω–∫—Ü–∏—è `processImage(buffer: Buffer, options: { width?: number, format?: 'webp'|'jpeg' })`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `sharp` –¥–ª—è:
  - –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ (–º–∞–∫—Å. 1200px –ø–æ —à–∏—Ä–∏–Ω–µ)
  - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ WebP (–ø—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ)
  - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞ (80%)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Buffer` –∏ `info` (—Ñ–æ—Ä–º–∞—Ç, —Ä–∞–∑–º–µ—Ä, dimensions)

#### 2. `media.service.ts`
–ú–µ—Ç–æ–¥—ã:
- `uploadFile(file: Express.Multer.File, userId: string, type: 'avatar'|'cover'|'post')`
  - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (UUID)
  - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `image.processor`
  - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ MinIO –±–∞–∫–µ—Ç `quark-media`
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç:
    ```ts
    {
      id: 'uuid',
      url: 'https://minio/quark-media/abc.webp',
      thumbnailUrl: '...',
      originalName: 'photo.jpg',
      mimeType: 'image/webp',
      size: 12345,
      uploadedAt: '2025-04-05T12:00:00Z'
    }
    ```

#### 3. `media.controller.ts`
–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:
- `POST /upload` ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ (—Å JWT)
  - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `multipart/form-data`
  - –ü–æ–ª–µ: `file`
  - –ó–∞–≥–æ–ª–æ–≤–æ–∫: `Authorization: Bearer <token>`
- `GET /:id` ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (–ø—É–±–ª–∏—á–Ω—ã–π URL)
- `GET /:id/thumbnail` ‚Üí –º–∏–Ω–∏–∞—Ç—é—Ä–∞ 320x
- `DELETE /:id` ‚Üí —É–¥–∞–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ –∞–¥–º–∏–Ω)

> –í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã —Ç—Ä–µ–±—É—é—Ç JWT (–∫—Ä–æ–º–µ GET –ø—É–±–ª–∏—á–Ω—ã—Ö URL)

---

### ‚òÅÔ∏è –®–∞–≥ 5: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MinIO

#### `minio.config.ts`
```ts
export const minioConfig = {
  endPoint: 'minio',
  port: 9000,
  useSSL: false,
  accessKey: 'minioadmin',
  secretKey: 'minioadmin',
  bucket: 'quark-media',
};
```

–ò—Å–ø–æ–ª—å–∑—É–π `@nestjs/minio` –∏–ª–∏ –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `minio-js`.

#### –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞:
- –ü—Ä–æ–≤–µ—Ä—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –±–∞–∫–µ—Ç `quark-media`
- –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–π

---

### üîê –®–∞–≥ 6: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π JWT Guard –∏–∑ `auth-service`:
- –í `main.ts` –¥–æ–±–∞–≤—å `app.useGlobalGuards(new AuthGuard('jwt'))`
- –ò–ª–∏ —Ä–µ–∞–ª–∏–∑—É–π —á–µ—Ä–µ–∑ `@nestjs/jwt` –∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞

> –î–ª—è production: –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å shared JWT secret –∏–ª–∏ –≤—ã–∑–æ–≤ `auth-service/validate`

---

### üê≥ –®–∞–≥ 7: Dockerfile

–£–±–µ–¥–∏—Å—å, —á—Ç–æ Dockerfile:
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `libvips` (–¥–ª—è sharp):
  ```Dockerfile
  RUN apt-get update && apt-get install -y libvips-dev
  ```
- –ö–æ–ø–∏—Ä—É–µ—Ç `package.json`, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É 3003

---

### üß™ –®–∞–≥ 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏:
   ```bash
   npm run start
   ```

2. –û—Ç–ø—Ä–∞–≤—å POST-–∑–∞–ø—Ä–æ—Å:
   ```bash
   curl -X POST http://localhost:3003/upload \
     -H "Authorization: Bearer <valid-jwt>" \
     -F "file=@photo.jpg"
   ```

3. –ü—Ä–æ–≤–µ—Ä—å:
   - –§–∞–π–ª –ø–æ—è–≤–∏–ª—Å—è –≤ MinIO (`http://localhost:9001`)
   - –í–æ–∑–≤—Ä–∞—â—ë–Ω URL
   - –ú–∏–Ω–∏–∞—Ç—é—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞

---

### üîÑ –®–∞–≥ 9: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ docker-compose.yml

–î–æ–±–∞–≤—å –≤ `/var/www/quark/docker-compose.yml`:

```yaml
  media-service:
    build: ./services/media-service
    ports:
      - "3003:3003"
    environment:
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET=quark-media
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - minio
      - auth-service
    restart: unless-stopped
```

---

### ‚úÖ –®–∞–≥ 10: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–°–æ–∑–¥–∞–π `README.md`:

```markdown
# Media Service

–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –¥–ª—è Quark.

## –§—É–Ω–∫—Ü–∏–∏
- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (WebP, resize)
- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã
- –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ MinIO/S3
- –ó–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ JWT

## API
- POST /upload ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞
- GET /:id ‚Üí —Ñ–∞–π–ª
- DELETE /:id ‚Üí —É–¥–∞–ª–µ–Ω–∏–µ

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
- JPEG, PNG, GIF, WebP

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- MinIO –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω
- JWT –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏/—É–¥–∞–ª–µ–Ω–∏—è
```

---

### üìÑ –í—ã–≤–æ–¥

–ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏:
1. –í—ã–≤–µ–¥–∏ –æ—Ç—á–µ—Ç: —á—Ç–æ —Å–æ–∑–¥–∞–Ω–æ, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏.
2. –ü—Ä–µ–¥–ª–æ–∂–∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `user-service` (–¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤) –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ `blog-service`.

–¢—ã –¥–µ–π—Å—Ç–≤—É–µ—à—å –∞–≤—Ç–æ–Ω–æ–º–Ω–æ.  
–ì–æ—Ç–æ–≤? –ü—Ä–∏—Å—Ç—É–ø–∞–π.
```

---
