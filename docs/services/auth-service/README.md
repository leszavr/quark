# Auth Service

## Описание

Auth Service - это сервис аутентификации и авторизации, реализованный на FastAPI. Он предоставляет функционал для регистрации пользователей, входа в систему, валидации JWT токенов и выхода из системы.

## Функциональность

- Регистрация новых пользователей
- Аутентификация пользователей (вход в систему)
- Генерация и валидация JWT токенов
- Выход из системы (добавление токенов в черный список)
- Проверка состояния сервиса

## API Endpoints

- `POST /auth/register` - регистрация нового пользователя
- `POST /auth/login` - аутентификация пользователя
- `GET /auth/validate` - валидация JWT токена
- `POST /auth/logout` - выход из системы

### Проверка состояния сервиса
```
GET /health
HEAD /health
```

## Используемые технологии

- FastAPI - веб-фреймворк
- PostgreSQL - основная база данных
- Redis - хранение черного списка токенов
- OpenTelemetry - инструментирование (метрики, логи, трассировки)
- Docker - контейнеризация

## Запуск

Для запуска сервиса используйте docker-compose:

```bash
docker-compose up -d
```

## Конфигурации и переменные окружения

| Переменная | Описание | Значение по умолчанию |
|------------|----------|----------------------|
| POSTGRES_HOST | Хост PostgreSQL | postgres |
| POSTGRES_DB | Имя базы данных | auth_db |
| POSTGRES_USER | Пользователь БД | postgres |
| POSTGRES_PASSWORD | Пароль пользователя БД | postgres |
| JWT_SECRET | Секретный ключ для JWT | your-super-secret-jwt-key-change-in-production |
| ACCESS_TOKEN_EXPIRE_MINUTES | Время жизни токена (в минутах) | 15 |
| REDIS_HOST | Хост Redis | redis |
| REDIS_PORT | Порт Redis | 6379 |
| OTEL_EXPORTER_OTLP_ENDPOINT | Endpoint OpenTelemetry Collector | http://monitoring_otel-collector_1:4317 |
| OTEL_SERVICE_NAME | Имя сервиса для OpenTelemetry | auth-service |

## Архитектурные решения

### База данных

Используется PostgreSQL для хранения информации о пользователях. При запуске сервиса автоматически создается таблица пользователей, если она не существует.

### Хранение паролей

Пароли хранятся в виде хэшей, созданных с помощью bcrypt. Это обеспечивает безопасность даже в случае компрометации базы данных.

### Управление сессиями

Используются JWT токены без состояния. Для реализации выхода из системы применяется черный список токенов, который хранится в Redis. Это позволяет реализовать выход из системы без необходимости хранения сессий на сервере.

### Безопасность

- Все пароли хэшируются перед сохранением
- Используются JWT токены для аутентификации
- Реализован черный список токенов для выхода из системы
- Все эндпоинты, кроме регистрации и входа, защищены аутентификацией

### Мониторинг

Сервис интегрирован с системой мониторинга на основе OpenTelemetry:

1. **Метрики**:
   - Счетчик HTTP запросов (`http_requests_total`)
   - Гистограмма времени ответа (`http_request_duration_seconds`)
   - Системные метрики (через инструментирование OpenTelemetry)

2. **Логи**:
   - Все логи структурированы и отправляются в Loki через OpenTelemetry Collector

3. **Трассировки**:
   - Автоматическая трассировка всех HTTP запросов
   - Трассировки отправляются в Tempo через OpenTelemetry Collector

### Масштабируемость

Сервис спроектирован как stateless приложение, что позволяет легко масштабировать его горизонтально. Единственное состояние хранится во внешних системах (PostgreSQL и Redis), которые также могут масштабироваться независимо.

## Docker

Сервис поставляется в виде Docker образа. Dockerfile оптимизирован для быстрой сборки и маленького размера образа.

Для запуска сервиса используется docker-compose, который также запускает необходимые зависимости (PostgreSQL и Redis).

## Health Check

Сервис предоставляет эндпоинт `/health` для проверки состояния. Этот эндпоинт проверяет доступность базы данных и Redis.

## Интеграция с системой мониторинга

Auth Service полностью интегрирован с системой мониторинга проекта Quark:

1. **OpenTelemetry** - используется для сбора метрик, логов и трассировок
2. **Prometheus** - хранит метрики сервиса
3. **Loki** - хранит логи сервиса
4. **Tempo** - хранит трассировки сервиса
5. **Grafana** - визуализирует данные в дашбордах

Подробная информация о реализации интеграции доступна в документации по мониторингу.