# Threat Model Report (STRIDE)

## Версия
1.0

## Дата
2025-04-05

## Автор
Quark Security Team (с участием Qwen, Grok)

## Статус
Утверждён

---

## 1. Введение

### Цель
Идентифицировать и оценить угрозы безопасности в архитектуре Quark, основанной на микросервисах, event-driven подходе и ИИ-агентах.

### Область охвата
- Все сервисы: `auth`, `blog`, `messaging`, `ai-orchestrator`, `plugin-hub`
- Взаимодействие через API, NATS, WebSocket
- Хранение данных: PostgreSQL, Redis, MinIO
- Участники: пользователи, администраторы, сторонние разработчики

### Методология
Используется **STRIDE** — матрица угроз от Microsoft:
- **S**poofing (подделка)
- **T**ampering (подделка данных)
- **R**epudiation (отказ от действий)
- **I**nformation Disclosure (утечка данных)
- **D**enial of Service (DoS)
- **E**levation of Privilege (повышение привилегий)

---

## 2. Угрозы и контрмеры

### S1. Подделка токена (Spoofing: JWT)

| Атрибут | Значение |
|--------|--------|
| **Описание** | Атакующий подделывает JWT, чтобы получить доступ к чужому аккаунту |
| **Цель** | `auth-service`, `api-gateway` |
| **Пример атаки** | Получен токен через XSS → изменён `sub` → использован для доступа к профилю |
| **Критичность** | Высокая |
| **Контрмеры** | 
| - Использование **сильного секрета (JWT_SECRET)**, хранящегося в **Vault** |
| - Подпись токена алгоритмом **HS256** (или RS256 при масштабировании) |
| - Проверка `exp`, `iss`, `aud` в каждом сервисе |
| - **Short-lived tokens** (15 мин) + refresh token (7 дней) |
| - Мониторинг подозрительных входов (IP, геолокация) |
| **Связанные документы** | `adr-005-jwt-auth.md`, `iam.md` |

---

### T1. Подделка события (Tampering: Event)

| Атрибут | Значение |
|--------|--------|
| **Описание** | Атакующий подделывает событие (например, `post.published`) с поддельным `user_id` |
| **Цель** | `NATS JetStream`, `blog-service` |
| **Пример атаки** | Отправлено событие `post.published` с `user_id=admin` → попытка модерации от имени админа |
| **Критичность** | Высокая |
| **Контрмеры** |
| - Все события подписываются **цифровой подписью** (HMAC) |
| - Проверка подписи в `event-validator` сервисе |
| - Валидация `user_id` через `auth-service` при обработке события |
| - Аудит всех событий в `audit-log` (PostgreSQL) |
| **Связанные документы** | `asyncapi-events.yaml`, `secure-arch-guidelines.md` |

---

### R1. Отказ от действия (Repudiation)

| Атрибут | Значение |
|--------|--------|
| **Описание** | Пользователь опубликовал нарушающий пост и отрицает это |
| **Цель** | `blog-service`, `moderation-service` |
| **Пример атаки** | "Я не писал этот пост, это сделал ИИ!" |
| **Критичность** | Средняя |
| **Контрмеры** |
| - **Аудит всех действий** в `audit-log`:
  ```json
  { "user_id": "u123", "action": "post.create", "timestamp": "2025-04-05T10:00:00Z", "ip": "1.2.3.4" }
  ```
| - Подпись действий ИИ: `ai_agent: "phi-3-mini", approved_by: "user-123"` |
| - Логирование WebSocket-сессий (для мессенджера) |
| **Связанные документы** | `data-lifecycle.md`, `incident-response.md` |

---

### I1. Утечка данных (Information Disclosure)

| Атрибут | Значение |
|--------|--------|
| **Описание** | Утечка персональных данных (email, IP, медиа) через API или логи |
| **Цель** | `user-service`, `media-service`, `logs` |
| **Пример атаки** | `GET /users` возвращает email всех пользователей |
| **Критичность** | Высокая |
| **Контрмеры** |
| - **Минимизация данных в API**: `/users/me` → только свой профиль |
| - **Шифрование at rest**: PostgreSQL (TDE), MinIO (SSE-S3) |
| - **Шифрование in transit**: TLS 1.3 для всех сервисов |
| - **Структурированные логи**: без PII (персональных данных) |
| - **WAF (Cloudflare)**: защита от инъекций |
| **Связанные документы** | `compliance-checklist.md`, `secure-arch-guidelines.md` |

---

### D1. Атака типа DoS/DDoS (Denial of Service)

| Атрибут | Значение |
|--------|--------|
| **Описание** | Перегрузка сервисов запросами (например, flood на `/auth/login`) |
| **Цель** | `api-gateway`, `auth-service`, `nats` |
| **Пример атаки** | 10000 RPS на `/posts` → падение `blog-service` |
| **Критичность** | Высокая |
| **Контрмеры** |
| - **Rate limiting** в API Gateway: 1000 req/hour на IP |
| - **WAF (Cloudflare)**: защита от DDoS |
| - **Bulkhead в NATS**: ограничение потребителей |
| - **Autoscaling (K8s HPA)**: при росте нагрузки |
| - **Circuit Breaker** в BFF при недоступности сервиса |
| **Связанные документы** | `capacity-plan.md`, `deployment-runbook.md` |

---

### E1. Повышение привилегий (Elevation of Privilege)

| Атрибут | Значение |
|--------|--------|
| **Описание** | Пользователь получает права модератора или администратора без разрешения |
| **Цель** | `auth-service`, `admin-panel` |
| **Пример атаки** | В `JWT` изменён `roles: ["admin"]` |
| **Критичность** | Критическая |
| **Контрмеры** |
| - **RBAC (Role-Based Access Control)** во всех сервисах |
| - **Проверка ролей** через `auth-service` при каждом запросе |
| - **Минимальные привилегии**: пользователь не может назначить себе роль |
| - **Аудит изменений ролей** в `audit-log` |
| - **MFA для администраторов** (на этапе v2) |
| **Связанные документы** | `iam.md`, `adr-005-jwt-auth.md` |

---

## 3. Угрозы, связанные с ИИ

### AI-T1. Подмена ИИ-агента

| Атрибут | Значение |
|--------|--------|
| **Описание** | Злоумышленник подключает вредоносный модуль, имитирующий `ai-moderator` |
| **Цель** | `plugin-hub`, `ai-orchestrator` |
| **Контрмеры** |
| - **Верификация модулей** перед активацией (человек одобряет)
| - **Песочница (WASM/Docker)**: изоляция выполнения
| - **Ограничение прав**: модуль не имеет доступа к `auth-service`
| - **Мониторинг поведения**: аномалии в генерации контента

---

### AI-I1. Утечка контекста ИИ

| Атрибут | Значение |
|--------|--------|
| **Описание** | ИИ-агент сохраняет и передаёт конфиденциальные данные из диалогов |
| **Контрмеры** |
| - **Очистка контекста** после сессии
| - **Нет хранения в логах**
| - **Шифрование контекста** в Redis
| - **Политика хранения**: 1 час

---

## 4. Риски, связанные с модульностью

| Риск | Описание | Контрмера |
|------|--------|----------|
| **Небезопасный модуль** | Сторонний модуль содержит уязвимость | Песочница, ручное одобрение |
| **Несовместимость событий** | Модуль отправляет события в неверном формате | Проверка схемы в `Schema Registry` |
| **Перегрузка event bus** | Модуль генерирует слишком много событий | Rate limiting на уровне NATS |

---

## 5. Инструменты и процессы

| Инструмент | Назначение |
|----------|-----------|
| **OWASP ZAP** | Сканирование на уязвимости |
| **SonarQube** | Статический анализ кода |
| **Sentry** | Отслеживание ошибок и исключений |
| **Vault** | Управление секретами |
| **Grafana + OpenTelemetry** | Мониторинг аномалий |
| **k6 + OWASP ZAP** | Автоматизированное тестирование на проникновение |

---

## 6. Incident Response (связь с `incident-response.md`)

При обнаружении угрозы:
1. Получен алерт (Grafana/Sentry)
2. Уведомление команды (Telegram/Slack)
3. Изоляция сервиса (K8s: scale to 0)
4. Анализ логов и трейсов
5. Исправление
6. Post-mortem и обновление этого документа

---

## 7. Пересмотр
- Раз в **квартал**
- После **каждого инцидента**
- При **добавлении нового критичного сервиса**