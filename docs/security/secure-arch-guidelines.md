# Руководство по безопасной архитектуре

## Версия
1.0

## Статус
Утверждён

## Цель
Обеспечить безопасность системы на всех уровнях: от кода до инфраструктуры.

---

## 1. Общие принципы

- ✅ Все API — HTTPS (TLS 1.3)
- ✅ Никаких секретов в коде или конфигах → только **Vault**
- ✅ Минимальные привилегии (Principle of Least Privilege)
- ✅ Все события — с цифровой подписью
- ✅ Аудит всех критичных действий
- ✅ Rate limiting на всех public endpoint’ах

---

## 2. Безопасность по сервисам

### 2.1. `auth-service`
- ✅ Использует **strong hashing (bcrypt)** для паролей
- ✅ JWT с коротким сроком жизни (15 мин)
- ✅ Refresh token — одноразовый, хранится в БД
- ✅ Rate limiting: 5 попыток входа / минуту
- ✅ MFA для администраторов (v2)

### 2.2. `blog-service`
- ✅ Санитизация HTML (защита от XSS)
- ✅ Проверка `user_id` при редактировании поста
- ✅ CORS: только с `quark.com`, `*.quark.com`
- ✅ Rate limiting: 100 POST / час на пользователя

### 2.3. `messaging-service`
- ✅ WebSocket: аутентификация через JWT в URL
- ✅ Шифрование сообщений в транзите (WSS)
- ✅ Очистка контекста после сессии
- ✅ Rate limiting: 100 сообщений / минуту

### 2.4. `ai-orchestrator`
- ✅ Ограничение длины промпта (5000 токенов)
- ✅ Фильтрация запрещённых тем (NSFW, инструкции по вреду)
- ✅ Контекст — в зашифрованном Redis
- ✅ Аудит всех генераций

### 2.5. `plugin-hub`
- ✅ Модули проходят ручное одобрение
- ✅ WASM-модули — в песочнице (wasmedge)
- ✅ Docker-модули — без привилегий, без доступа к сети
- ✅ Ограниченные права: только подписка на разрешённые события

---

## 3. Защита данных

| Уровень | Технология | Описание |
|--------|-----------|---------|
| **In Transit** | TLS 1.3 | Все сервисы, NATS, API Gateway |
| **At Rest** | TDE, AES-256 | PostgreSQL, Redis, MinIO |
| **Секреты** | HashiCorp Vault | Централизованное управление |
| **JWT** | HS256 / RS256 | Подпись и валидация |
| **NATS** | TLS + Auth | Аутентификация и шифрование |

---

## 4. Безопасность модулей

- ✅ Все модули должны иметь `module-manifest.yaml`
- ✅ Проверка цифровой подписи образа
- ✅ Статический анализ (Trivy, SonarQube) перед деплоем
- ✅ Запрещены:
  - Прямые вызовы к `auth-service`
  - Доступ к `vault`
  - Выполнение shell-команд

---

## 5. Проверка на уязвимости

| Инструмент | Назначение | Частота |
|----------|-----------|--------|
| **Trivy** | Сканирование образов | При каждом CI |
| **SonarQube** | SAST, качество кода | При каждом PR |
| **OWASP ZAP** | DAST, инъекции | Перед релизом |
| **k6 + ZAP** | Автоматизированный тест на проникновение | Еженедельно |

---

## 6. Рекомендации по протоколам

### 6.1. JWT
- ✅ Использовать `sub`, `roles`, `permissions`
- ✅ Валидировать `exp`, `iss`, `aud`
- ✅ Хранить секрет в Vault

### 6.2. NATS
- ✅ Включить TLS
- ✅ Использовать JetStream для durable consumers
- ✅ Настроить rate limiting на потребителях

### 6.3. gRPC
- ✅ Использовать mTLS
- ✅ Валидировать `.proto` схемы
- ✅ Ограничивать размер сообщений

### 6.4. WebAssembly
- ✅ Запускать в `wasmedge` или `wasmtime`
- ✅ Ограничивать доступ к сети и файловой системе
- ✅ Разрешать только `http:outbound`, `events:publish`