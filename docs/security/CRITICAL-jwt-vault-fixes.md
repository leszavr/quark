# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã JWT/Vault - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –∑–∞–¥–∞—á–∞

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

### 1. Vault –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –û–¢–°–£–¢–°–¢–í–£–ï–¢
**–ü—Ä–æ–±–ª–µ–º–∞:** JWT_SECRET —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
**–†–∏—Å–∫:** –ö–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è –µ–¥–∏–Ω–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞ = –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
**–†–µ—à–µ–Ω–∏–µ:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Vault

### 2. –†–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê  
**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π JWT_SECRET –±–µ–∑ —Ä–æ—Ç–∞—Ü–∏–∏
**–†–∏—Å–∫:** –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è –ø—Ä–∏ —É—Ç–µ—á–∫–µ
**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç

### 3. –¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê
**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–æ–ª—å–∫–æ User Tokens, –Ω–µ—Ç Service –∏ Hub Tokens
**–†–∏—Å–∫:** –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

## üéØ –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)

### –≠—Ç–∞–ø 1: Vault –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–ö–†–ò–¢–ò–ß–ù–û)
1. –°–æ–∑–¥–∞—Ç—å Vault –∫–ª–∏–µ–Ω—Ç –≤ Auth Service
2. –ü–æ–ª—É—á–∞—Ç—å JWT_SECRET –∏–∑ Vault –≤–º–µ—Å—Ç–æ env
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

### –≠—Ç–∞–ø 2: Service Tokens (–í–´–°–û–ö–ò–ô)
1. –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
2. Plugin Hub –≤—ã–¥–∞–µ—Ç Service Tokens
3. –í–∞–ª–∏–¥–∞—Ü–∏—è Service Tokens –≤ Auth Service

### –≠—Ç–∞–ø 3: –†–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ (–í–´–°–û–ö–ò–ô)  
1. –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ JWT_SECRET
2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –æ –Ω–æ–≤–æ–º —Å–µ–∫—Ä–µ—Ç–µ
3. Graceful –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è

### –≠—Ç–∞–ø 4: Hub Tokens (–°–†–ï–î–ù–ò–ô)
1. –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è Plugin Hub
2. –ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏
3. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤—ã–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–æ–≤

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### Vault –∫–ª–∏–µ–Ω—Ç –¥–ª—è Auth Service
```typescript
import * as vault from 'node-vault';

@Injectable()
export class VaultService {
  private vault = vault({
    apiVersion: 'v1',
    endpoint: process.env.VAULT_URL || 'http://vault:8200',
    token: process.env.VAULT_TOKEN
  });

  async getJWTSecret(): Promise<string> {
    const result = await this.vault.read('secret/jwt');
    return result.data.secret;
  }

  async rotateJWTSecret(): Promise<string> {
    const newSecret = crypto.randomBytes(64).toString('hex');
    await this.vault.write('secret/jwt', { secret: newSecret });
    return newSecret;
  }
}
```

### –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π JWT Module
```typescript
@Module({
  imports: [
    JwtModule.registerAsync({
      useFactory: async (vaultService: VaultService) => ({
        secret: await vaultService.getJWTSecret(),
        signOptions: { expiresIn: '15m' } // –ö–æ—Ä–æ—Ç–∫–∏–π TTL
      }),
      inject: [VaultService],
    }),
  ],
})
export class AuthModule {}
```

### Service Token –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
```typescript
generateServiceToken(serviceId: string): string {
  const payload = {
    sub: `service:${serviceId}`,
    service_id: serviceId,
    roles: ['service'],
    permissions: this.getServicePermissions(serviceId),
    iss: 'quark-plugin-hub',
    aud: this.getServiceAudience(serviceId)
  };
  
  return this.jwtService.sign(payload, { expiresIn: '1h' });
}
```

## ‚ö° –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

1. **–°–µ–π—á–∞—Å:** Vault –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Auth Service
2. **–°–µ–≥–æ–¥–Ω—è:** Service Tokens –¥–ª—è Plugin Hub ‚Üî Auth Service
3. **–ó–∞–≤—Ç—Ä–∞:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤
4. **–ù–µ–¥–µ–ª—è:** –ü–æ–ª–Ω–∞—è —Ç—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø–æ–ª—É—á–∏–º:
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Vault
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç  
- ‚úÖ –¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
- ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å:** üö® –ö–†–ò–¢–ò–ß–ù–û - —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
