# Disaster Recovery Plan

## Версия
1.0

## Статус
Утверждён

## Цель
Обеспечить восстановление системы после катастрофы (поломка ЦОД, потеря данных, сбой сети) в рамках:
- **RTO (Recovery Time Objective)**: 30 минут
- **RPO (Recovery Point Objective)**: 5 минут

## 1. Сценарии катастроф

| Сценарий | Приоритет | Описание |
|--------|----------|---------|
| Полная потеря ЦОД | Критический | Физический сбой дата-центра |
| Потеря БД (PostgreSQL) | Критический | Ошибочное удаление, повреждение |
| Потеря NATS кластера | Высокий | Сбой event bus |
| Утечка данных | Критический | Компрометация PII |
| Атака DDoS на API Gateway | Высокий | Недоступность сервиса |

## 2. Архитектура отказоустойчивости

```
[Основной ЦОД]
  │
  ├── PostgreSQL (Primary) → Replication → [Резервный ЦОД]
  ├── MinIO (erasure coding) → Backup → S3
  ├── NATS JetStream (Clustered)
  └── Velero → Ежедневные бэкапы в S3

[Резервный ЦОД]
  │
  ├── PostgreSQL (Standby) → Hot Standby
  ├── MinIO (Replica)
  └── Автоматический failover (via DNS + Cloudflare)
```

## 3. Процесс восстановления

### 3.1. Потеря ЦОД
1. Cloudflare переключает DNS на резервный ЦОД
2. Восстановить PostgreSQL из hot standby
3. Запустить MinIO с репликами
4. Проверить работоспособность NATS
5. Уведомить пользователей о восстановлении

### 3.2. Потеря БД
1. Остановить все сервисы, пишущие в БД
2. Восстановить из бэкапа с помощью Velero:
   ```bash
   velero restore create --from-backup postgres-backup-2025-04-05
   ```
3. Проверить целостность данных
4. Запустить сервисы
5. Провести post-mortem

### 3.3. Утечка данных
1. Изолировать сервис-источник
2. Отозвать все JWT-токены (через `auth-service` blacklist)
3. Провести аудит доступа
4. Уведомить пользователей (в рамках GDPR)
5. Обновить политики безопасности

## 4. Инструменты
- **Velero** — бэкап и восстановление K8s
- **S3** — хранилище бэкапов
- **Cloudflare** — DNS failover
- **Vault** — управление секретами
- **Prometheus + Grafana** — мониторинг восстановления

## 5. Проверка DRP
- Раз в **квартал** — тестовое восстановление
- После **каждого major release**
- После **изменения инфраструктуры**