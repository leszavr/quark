# ADR-007: Поддержка WebAssembly для безопасных пользовательских модулей

## Состояние
**Принято**

## Контекст
Quark позволяет сторонним разработчикам создавать **пользовательские модули** (например, `seo-analyzer`, `telegram-bridge`).

Проблема:
- Docker-модули **требуют высоких привилегий**
- Есть риск **выполнения вредоносного кода**
- Сложно **ограничить доступ к системе**

Необходимо предложить **более безопасную альтернативу** для **небольших, изолированных модулей**.

## Решение
Поддерживать **WebAssembly (WASM)** как **дополнительный формат модулей** наравне с Docker.

### Примеры использования:
- `seo-analyzer` — анализирует текст и возвращает рекомендации
- `ai-summarizer-light` — краткая генерация на основе промпта
- `custom-filter` — пользовательский фильтр для ленты

### Технологии:
- **Языки**: Rust, Go, AssemblyScript
- **Песочница**: WasmEdge, Wasmer
- **API**: доступ только к:
  - HTTP-клиенту (ограниченный)
  - Чтению входных данных
  - Отправке событий через `event-publisher`

## Обоснование
| Преимущество | Описание |
|-------------|---------|
| ✅ **Высокая безопасность** | WASM выполняется в изолированной песочнице, без доступа к сети, файловой системе |
| ✅ **Быстрый запуск** | Мгновенная инициализация (микросекунды) |
| ✅ **Кроссплатформенность** | Работает на любом хосте с WASM-рантаймом |
| ✅ **Малый размер** | Бинарники в разы меньше Docker-образов |
| ✅ **Поддержка LLM-агентов** | Лёгкие ИИ-агенты могут работать в WASM |

> 📌  _"WebAssembly позволяет запускать код в песочнице, обеспечивая безопасность и изоляцию"_

## Альтернативы
| Вариант | Почему не выбран |
|--------|------------------|
| **Только Docker** | Избыточен для простых модулей, выше риски |
| **Jail для Python/Node** | Менее надёжная изоляция |
| **Отказ от сторонних модулей** | Противоречит цели — открытая экосистема |

## Последствия
- ✅ Повышается **безопасность платформы**
- ✅ Упрощается **вход для разработчиков** (можно писать на Rust/Go)
- ❌ Не подходит для **тяжёлых задач** (обработка видео, LLM)
- ❌ Требуется **новый `module-runner`** для WASM
- 🟡 Нужно **обновить `module-manifest.yaml`**:
  ```yaml
  type: wasm | docker
  runtime: wasmedge
  permissions:
    - http:outbound
    - events:publish
  ```