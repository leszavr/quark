# Test Plan

## Версия
1.0

## Дата
2025-04-05

## Статус
Утверждён

## 1. Цель
Обеспечить высокое качество кода и стабильность системы Quark на всех этапах разработки, с помощью комплексного подхода к тестированию.

Цель: **95% покрытие по ключевым сервисам, 0 критических багов в production**.

---

## 2. Уровни тестирования

| Уровень | Инструменты | Ответственный | Частота | Охват |
|--------|------------|--------------|--------|-------|
| **Unit** | Pytest, Jest, unittest | Разработчик | При каждом коммите | Логика функций, валидация |
| **Integration** | Supertest, Playwright, HTTPX | Разработчик | При каждом коммите | Взаимодействие сервисов, API |
| **E2E** | Playwright, Cypress | QA / ИИ | Ежедневно | Пользовательские сценарии |
| **Load** | k6, Locust | DevOps / ИИ | Перед релизом | Производительность, SLO |
| **Security** | OWASP ZAP, SonarQube, Trivy | Security Team | Перед релизом | Уязвимости, PII, инъекции |
| **AI-тесты** | ИИ (Qwen) | AI Ops Agent | При генерации кода | Генерация тест-кейсов, edge cases |

---

## 3. Ключевые сценарии тестирования

### 3.1. Аутентификация и профиль
- Пользователь регистрируется → получает JWT
- Вход с неверным паролем → 401
- Обновление профиля → данные сохраняются
- Удаление аккаунта → все данные удаляются (GDPR)

### 3.2. Публикация поста
- Пользователь создаёт пост → пост появляется в ленте
- Загрузка изображения → сохраняется в MinIO
- Событие `post.published` → отправляется в NATS
- `search-service` индексирует пост
- `notification-service` отправляет уведомление

### 3.3. Мессенджер
- Пользователь A отправляет сообщение пользователю B → B получает его
- WebSocket соединение устойчиво при 300 VU
- Статус "онлайн" обновляется
- История сообщений сохраняется

### 3.4. ИИ-агенты
- `ai-ops-agent` обнаруживает высокую задержку → предлагает исправление
- `ai-moderator` блокирует пост с запрещённым контентом
- `ai-writer` генерирует пост → человек редактирует → публикует

### 3.5. Модульность
- Разработчик загружает `seo-analyzer.wasm` → модуль активируется
- Модуль подписывается на `post.published` → обрабатывает контент
- При ошибке — изолируется, не падает вся система

---

## 4. Процесс тестирования

### Этап 1: Локальная разработка
- Разработчик пишет **unit- и integration-тесты**
- Запускает `pytest` / `jest` локально
- Проверяет покрытие: `pytest --cov=src`

### Этап 2: CI/CD Pipeline
```yaml
# .github/workflows/ci.yml
- name: Run Unit Tests
  run: pytest tests/unit/

- name: Run Integration Tests
  run: pytest tests/integration/

- name: Run E2E Tests
  run: npx playwright test

- name: Run Load Tests
  run: k6 run load-tests/read-posts.js

- name: Security Scan
  run: |
    docker run --rm -v "$PWD:/app" trivy filesystem /app
    sonar-scanner
```

### Этап 3: Staging
- Запуск **E2E и нагрузочных тестов** на staging
- Проверка метрик в **Grafana**
- Ручное тестирование (если нужно)

### Этап 4: Production
- **Canary-деплой** 5% трафика
- Мониторинг ошибок в **Sentry**
- Если SLO выполняется → 100% rollout

---

## 5. Покрытие кода
- **Минимум**: 80%
- **Цель**: 95%
- Измеряется в **SonarQube** и **Grafana**
- Отчёт: ежедневный в `#testing` канал

---

## 6. Ответственные
| Роль | Ответственный |
|------|---------------|
| **Test Lead** | QA Lead |
| **Unit/Integration** | Разработчик |
| **E2E** | QA Engineer |
| **Load Testing** | DevOps |
| **Security Testing** | Security Team |
| **AI Test Generation** | AI Ops Agent (Qwen) |

---

## 7. Инструменты
- **Pytest / Jest** — unit-тесты
- **Playwright / Cypress** — E2E
- **k6** — нагрузка
- **OWASP ZAP** — безопасность
- **SonarQube** — статический анализ
- **Sentry** — отслеживание ошибок
- **Grafana** — визуализация покрытия